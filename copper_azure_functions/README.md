# Copper Azure Functions

This directory contains the Azure Functions used in the Copper project. These functions provide backend services for the Copper application, including secure interaction with the Azure OpenAI Service.

## Functions

### generateCompletion

This function serves as an HTTP endpoint that accepts a prompt from the caller (the Copper app) and returns a completion generated by the Azure OpenAI Service.

#### How it works

1. Receives an HTTP POST request containing a JSON body with a "prompt" field.
2. Validates the presence of the "prompt" field in the request body.
3. Retrieves the OpenAI API key from Azure Key Vault using managed identity.
4. Sends the prompt to the Azure OpenAI Service and requests a completion.
5. Returns the generated completion text in the HTTP response.

#### Example request

```json
{
  "prompt": "What is the air speed velocity of an unladen swallow?"
}
```

## Setup

### Prerequisites

- Node.js
- Azure Functions Core Tools
- Azure subscription
- Azure Key Vault with the OpenAI API key stored as a secret

### Installation

1. Clone the repository:

```sh
git clone https://github.com/Toglefritz/Copper.git
cd copper/copper_azure_functions
```

2. Install dependencies:

```sh
npm install
```

3. Set up environment variables:

Create a `.env` file in the `copper_azure_functions` directory with the following content:

```env
KEY_VAULT_NAME=your-key-vault-name
AZURE_OPENAI_ENDPOINT=your-openai-endpoint
```

### Running Locally

1. Start the Azure Functions runtime:

```sh
func start
```

2. Send a POST request to the function endpoint:

```sh
curl -X POST http://localhost:7071/generateCompletion -H "Content-Type: application/json" -d '{"prompt": "What is the air speed velocity of an unladen swallow?"}'
```

### Deployment

Deploy the Azure Functions to your Azure subscription:

```sh
func azure functionapp publish copperapp
```